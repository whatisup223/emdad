{% extends "base.html" %}

{% block title %}{% if is_rtl %}تقويم المواسم{% else %}Seasonality Calendar{% endif %} - {{ SITE_NAME }}{% endblock %}

{% block content %}
<section class="py-5">
  <div class="container">
    <div class="d-flex align-items-center justify-content-between mb-4 flex-wrap gap-2">
      <div>
        <div class="section-badge badge bg-gradient-primary text-white px-4 py-2 rounded-pill fs-6 fw-semibold">
          <i class="fas fa-calendar-alt me-2"></i>{% if is_rtl %}التقويم{% else %}Calendar{% endif %}
        </div>
        <h1 class="section-heading {{ 'arabic-heading' if is_rtl else 'english-heading' }} mb-0">
          {% if is_rtl %}مواسم توفر المنتجات{% else %}Product Seasonality{% endif %}
        </h1>
      </div>
      <div class="d-flex gap-2">
        <!-- Hide legacy header form; replaced by compact filter bar below -->
        <form class="d-none" method="get"></form>

      {% set months_names_en = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'] %}
      {% set months_names_ar = ['يناير','فبراير','مارس','أبريل','مايو','يونيو','يوليو','أغسطس','سبتمبر','أكتوبر','نوفمبر','ديسمبر'] %}


      <style>
        /* Compact filter bar */
        .calendar-filter .form-select,
        .calendar-filter .form-control { height: 34px; padding-top: 4px; padding-bottom: 4px; }
        .calendar-filter .btn { height: 34px; padding: 4px 10px; }
        .calendar-filter label { font-size: .85rem; color:#6c757d; }
        .calendar-filter .form-check { margin-inline-end: .25rem; }
        .calendar-filter .form-check-input { transform: scale(.9); margin-top: .1rem; }
        #calMonths { min-height: 90px; }
      </style>


      <!-- Category pills like Products page -->
      <section class="py-3 bg-white border-bottom position-relative overflow-hidden category-filter-section">
        <div class="container px-0">
          <div class="d-flex flex-wrap gap-2 category-filter">
            <a href="{{ url_for('main.calendar') }}" class="btn {% if not current_category %}btn-primary{% else %}btn-outline-primary{% endif %}">
              {% if is_rtl %}كل المنتجات{% else %}{{ _('All Products') }}{% endif %}
            </a>
            {% for c in categories %}
            <a href="{{ url_for('main.calendar', category=c.key) }}" class="btn {% if current_category and current_category==c.key %}btn-primary{% else %}btn-outline-primary{% endif %}">
              {{ c.get_name(current_language) }}
            </a>
            {% endfor %}
            <span class="ms-auto small text-muted d-none d-md-inline">{% if is_rtl %}عرض {{ filtered_count }} من {{ total_count }}{% else %}Showing {{ filtered_count }} of {{ total_count }}{% endif %}</span>
          </div>
        </div>
      </section>

      <!-- Match products page filter hover: peach gradient on hover -->
      <style>
        .category-filter .btn { border-radius: 999px; padding: .5rem 1rem; font-weight: 600; }
        .category-filter .btn-outline-primary { border-color: var(--secondary-color); color: var(--secondary-color); background: rgba(249,203,153,.1); transition: transform .15s ease, box-shadow .2s ease; }
        .category-filter .btn-outline-primary:hover,
        .category-filter .btn-outline-primary:focus,
        .category-filter .btn-outline-primary:active { background: var(--secondary-gradient); color: var(--dark-color); border-color: transparent; transform: translateY(-2px); box-shadow: 0 8px 20px rgba(249,203,153,.35); }
        .category-filter .btn-primary { background: var(--secondary-gradient); border-color: transparent; color: var(--dark-color); }
        @media (max-width: 576px) { .category-filter .btn { padding: .4rem .75rem; font-size: .9rem; } }
      </style>


      <script>
      document.addEventListener('DOMContentLoaded', function(){
        const stateBoxes = Array.from(document.querySelectorAll('.cal-filter-state'));
        const monthsSel = document.getElementById('calMonths');
        function getSelectedMonths(){ return Array.from(monthsSel.selectedOptions).map(o=>parseInt(o.value,10)); }
        function rowData(tr){
          // derive sets from the cell states in DOM to avoid recomputing server-side
          const months = { peak:new Set(), available:new Set(), limited:new Set(), iqf:new Set(), off:new Set() };
          tr.querySelectorAll('td .month-cell').forEach((cell, idx)=>{
            const m = idx+1; const st = Array.from(cell.classList).find(c=>c.startsWith('state-')).replace('state-','');
            (months[st]||months['off']).add(m);
          });
          return months;
        }
        function applyFilters(){
          const activeStates = stateBoxes.filter(b=>b.checked).map(b=>b.value); // OR
          const pickedMonths = new Set(getSelectedMonths());
          document.querySelectorAll('.calendar-table tbody tr').forEach(tr=>{
            const data = rowData(tr);
            let match = true;
            // State filter
            if(activeStates.length){
              match = activeStates.some(st=> (data[st]||new Set()).size>0 );
            }
            // Month filter
            if(match && pickedMonths.size){
              if(activeStates.length){
                // keep if any selected state has overlap with picked months
                match = activeStates.some(st=> [...(data[st]||new Set())].some(m=> pickedMonths.has(m)) );
              } else {
                // no states chosen: any non-off overlap
                const nonOff = ['peak','available','limited','iqf'];
                match = nonOff.some(st=> [...(data[st]||new Set())].some(m=> pickedMonths.has(m)) );
              }
            }
            tr.style.display = match? '': 'none';
          });
        }
        stateBoxes.forEach(b=> b.addEventListener('change', applyFilters));
        monthsSel.addEventListener('change', applyFilters);
        document.getElementById('calReset').addEventListener('click', ()=>{
          stateBoxes.forEach(b=> b.checked=false);
          Array.from(monthsSel.options).forEach(o=> o.selected=false);
          applyFilters();
        });
      });
      </script>

      </div>
    </div>

    <style>
      .calendar-grid { overflow:auto; border-radius: 16px; box-shadow: 0 8px 30px rgba(0,0,0,.08); border:1px solid #e9ecef; }
      .calendar-table { width:100%; border-collapse: separate; border-spacing:0; }
      .calendar-table thead th { position: sticky; top:0; z-index:2; background:#fff; box-shadow: inset 0 -1px 0 #e9ecef; }
      .calendar-table th, .calendar-table td { padding:.75rem; white-space:nowrap; }
      .product-col { position: sticky; left:0; background:#fff; z-index:1; box-shadow: inset -1px 0 0 #e9ecef; min-width: 220px; }
      .month-cell { width: 64px; min-width:64px; height: 30px; border-radius: 10px; border:1px solid transparent; background:#f8f9fa; position: relative; box-shadow: inset 0 1px 0 rgba(255,255,255,.18), 0 1px 2px rgba(0,0,0,.06); transition: transform .15s ease, box-shadow .15s ease, filter .15s ease; }
/* Fancy tooltip on hover */
.month-cell[data-tooltip]:hover{ transform: translateY(-1px); box-shadow: inset 0 1px 0 rgba(255,255,255,.18), 0 6px 16px rgba(0,0,0,.12); z-index:1001; }
.month-cell[data-tooltip]:hover::after{ content: attr(data-tooltip); position:absolute; left:50%; transform:translateX(-50%); bottom:calc(100% + 10px); background:#fff; color:#212529; padding:8px 12px; border-radius:10px; border:1px solid #e9ecef; white-space:nowrap; box-shadow:0 10px 26px rgba(0,0,0,.14); z-index:1002; font-size:12px; }
.month-cell[data-tooltip]:hover::before{ content:""; position:absolute; left:50%; transform:translateX(-50%); bottom:calc(100% + 2px); border:6px solid transparent; border-bottom-color:#fff; filter:drop-shadow(0 1px 0 #e9ecef); }
/* Accent border by state */
.state-peak[data-tooltip]:hover::after{ border-color:#2c5f4f; }
.state-available[data-tooltip]:hover::after{ border-color:#689b8a; }
.state-limited[data-tooltip]:hover::after{ border-color:#f9cb99; }
.state-off[data-tooltip]:hover::after{ border-color:#adb5bd; }
.state-iqf[data-tooltip]:hover::after{ border-color:#5bc0de; }
      .state-peak { background:linear-gradient(180deg,#2c5f4f,#244d40) !important; border-color:#244d40 !important; } /* dark green */
      .state-available { background:linear-gradient(180deg,#689b8a,#567f72) !important; border-color:#567f72 !important; } /* primary green */
      .state-limited { background:linear-gradient(180deg,#f9cb99,#f4b56f) !important; border-color:#f4b56f !important; } /* peach */
      .state-off { background:linear-gradient(180deg,#adb5bd,#8f9aa3) !important; border-color:#8f9aa3 !important; } /* gray */
      .state-iqf { background:linear-gradient(180deg,#5bc0de,#3aa9c7) !important; border-color:#3aa9c7 !important; } /* frozen */
      .month-cell:hover { box-shadow: 0 0 0 3px rgba(249,203,153,.35); }
      .product-name a { color:#2c5f4f; font-weight:600; text-decoration:none; }
      .product-name a:hover { text-decoration:underline; }
      .legend .dot { width:14px; height:14px; border-radius:4px; display:inline-block; margin-inline-end:.5rem; vertical-align:middle; }
      .legend .peak { background:#2c5f4f; }
      .legend .available { background:#689b8a; }
      .legend .limited { background:#f9cb99; }
      .legend .off { background:#adb5bd; }
    </style>

    <!-- Legend -->
    <div class="legend d-flex align-items-center gap-3 mb-3 flex-wrap">
      <span><span class="dot peak"></span>{% if is_rtl %}ذروة{% else %}Peak{% endif %}</span>
      <span><span class="dot available"></span>{% if is_rtl %}متاح{% else %}Available{% endif %}</span>
      <span><span class="dot limited"></span>{% if is_rtl %}محدود{% else %}Limited{% endif %}</span>
      <span><span class="dot off"></span>{% if is_rtl %}خارج الموسم{% else %}Off-season{% endif %}</span>
      <span><span class="dot" style="background:#5bc0de"></span>{% if is_rtl %}مجمّد{% else %}Frozen{% endif %}</span>

    </div>

    <div class="calendar-grid">
      <table class="calendar-table table align-middle mb-0">
        <thead>
          <tr>
            <th class="product-col">{% if is_rtl %}المنتج{% else %}Product{% endif %}</th>
            {% set months_names_en = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'] %}
            {% set months_names_ar = ['يناير','فبراير','مارس','أبريل','مايو','يونيو','يوليو','أغسطس','سبتمبر','أكتوبر','نوفمبر','ديسمبر'] %}
            {% for m in months %}
              <th>{{ months_names_ar[m-1] if is_rtl else months_names_en[m-1] }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% set q = request.args.get('q','')|lower %}
          {% for item in items %}
            {% if not q or (item.name or '')|lower is string and q in (item.name or '')|lower %}
            <tr>
              <th scope="row" class="product-col product-name">
                <a href="{{ url_for('main.product_detail', slug=item.slug) }}">{{ item.name }}</a>
              </th>
              {% for m in months %}
                {% set state = 'off' %}
                {% if m in item.peak %}{% set state = 'peak' %}
                {% elif m in item.available %}{% set state = 'available' %}
                {% elif m in item.limited %}{% set state = 'limited' %}
                {% elif item.iqf and (item.iqf.year_round if item.iqf.year_round is defined else false) %}{% set state = 'iqf' %}
                {% elif item.iqf and item.iqf.months is defined and (m in item.iqf.months) %}{% set state = 'iqf' %}
                {% elif item.iqf and (m in item.iqf) %}{% set state = 'iqf' %}
                {% endif %}
                <td>
                  {% set labels_en = {'peak':'Peak','available':'Available','limited':'Limited','off':'Off-season','iqf':'Frozen'} %}
                  {% set labels_ar = {'peak':'ذروة','available':'متاح','limited':'محدود','off':'خارج الموسم','iqf':'مجمّد'} %}
                  {% set month_name = months_names_ar[m-1] if is_rtl else months_names_en[m-1] %}
                  {% set state_label = (labels_ar if is_rtl else labels_en)[state] %}
                  <div class="month-cell state-{{ state }}" data-tooltip="{{ item.name }} — {{ month_name }} • {{ state_label }}" aria-label="{{ item.name }} — {{ month_name }} • {{ state_label }}"></div>
                </td>
              {% endfor %}
            </tr>
            {% endif %}
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</section>

<!-- Featured Products on Calendar Page -->
<section class="py-5 position-relative overflow-hidden">
  <div class="container position-relative">
    <div class="text-center mb-5" data-aos="fade-up">
      <div class="section-badge badge bg-gradient-secondary text-dark px-4 py-2 rounded-pill mb-3 fs-6 fw-semibold">
        <i class="fas fa-star me-2"></i>{{ _('Featured Products') }}
      </div>
      <h2 class="section-heading english-heading gradient-text">{{ _('Premium Quality Selection') }}</h2>
      <p class="lead english-text text-muted col-lg-8 mx-auto">
        {{ _('Discover our handpicked selection of the finest Egyptian agricultural products,') }}
        {{ _('each representing the pinnacle of quality and taste.') }}
      </p>
    </div>

    <div class="row g-4 products-grid">
      {% if featured_products %}
        {% for product in featured_products %}
        <div class="col-lg-4 col-md-6 col-sm-12 product-col" data-aos="fade-up" data-aos-delay="{{ loop.index0 * 100 }}">
          <div class="product-card card h-100 border-0 shadow-lg hover-lift position-relative overflow-hidden">
            <div class="position-absolute top-0 start-0 p-3 z-index-3">
              <span class="badge bg-gradient-secondary text-dark fw-semibold">
                <i class="fas fa-star me-1"></i>{{ _('Featured') }}
              </span>
            </div>

            <!-- Image -->
            <div class="product-image-wrapper position-relative overflow-hidden">
              {% set main_image = product.get_main_image() %}
              {% if main_image %}
              <img src="{{ url_for('main.uploaded_file', filename='products/' + main_image.filename) }}" class="card-img-top product-image" alt="{{ product.get_name(current_language) }}" style="height: 250px; object-fit: cover;">
              {% else %}
              <div class="card-img-top bg-gradient-primary d-flex align-items-center justify-content-center" style="height: 250px;">
                <i class="fas fa-apple-alt fa-4x text-white opacity-75"></i>
              </div>
              {% endif %}
            </div>

            <!-- Content -->
            <div class="card-body p-4">
              <div class="product-category mb-2">
                <span class="badge bg-light text-primary-custom fw-semibold">
                  {{ product.category.get_name(current_language) if product.category else _('Premium') }}
                </span>
              </div>

              <!-- Monthly availability chips -->
              {% set season = (product.get_seasonality_lang(current_language) or {}) %}
              {% if 'fresh' in season %}{% set season = season['fresh'] %}{% endif %}
              {% set months_names_en = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'] %}
              {% set months_names_ar = ['يناير','فبراير','مارس','أبريل','مايو','يونيو','يوليو','أغسطس','سبتمبر','أكتوبر','نوفمبر','ديسمبر'] %}
              {% set labels_en = {'peak':'Peak','available':'Available','limited':'Limited','off':'Off-season','iqf':'Frozen'} %}
              {% set labels_ar = {'peak':'ذروة','available':'متاح','limited':'محدود','off':'خارج الموسم','iqf':'مجمّد'} %}
              <div class="d-flex gap-1 flex-wrap mb-3">
                {% set peak = season.get('peak') or [] %}
                {% set available = season.get('available') or [] %}
                {% set limited = season.get('limited') or [] %}
                {% set iqf = season.get('iqf') or [] %}
                {% for idx in range(0,12) %}
                  {% set m = idx+1 %}
                  {% set st = 'off' %}
                  {% if m in peak %}{% set st='peak' %}
                  {% elif m in available %}{% set st='available' %}
                  {% elif m in limited %}{% set st='limited' %}
                  {% elif m in iqf %}{% set st='iqf' %}
                  {% endif %}
                  {% set label = (labels_ar if is_rtl else labels_en)[st] %}
                  {% set m_name = months_names_ar[idx] if is_rtl else months_names_en[idx] %}
                  <span class="rounded-pill px-2 py-1 border small state-chip state-{{ st }}" title="{{ product.get_name(current_language) }} — {{ m_name }} • {{ label }}"></span>
                {% endfor %}
              </div>

              <h5 class="card-heading {{ 'arabic-heading' if current_language == 'ar' else 'english-heading' }} mb-3">{{ product.get_name(current_language) }}</h5>
              <p class="card-text {{ 'arabic-text' if current_language == 'ar' else 'english-text' }} text-muted mb-4">
                {{ product.get_short_description(current_language) | truncate(100) if product.get_short_description(current_language) else _('Premium quality Egyptian agricultural product with exceptional taste and nutritional value.') }}
              </p>

              <div class="d-flex gap-2 mt-auto">
                <a href="{{ url_for('main.product_detail', slug=product.slug) }}" class="btn btn-outline-primary flex-grow-1 hover-lift" style="border-radius: 12px; border-width: 2px;">
                  <i class="fas fa-info-circle me-1"></i>{{ _('Details') }}
                </a>
                <a href="{{ url_for('main.contact') }}?product={{ product.slug }}" class="btn btn-primary hover-lift" style="border-radius: 12px; background: linear-gradient(135deg, #689b8a, #2c5f4f); border: none; box-shadow: 0 4px 15px rgba(104, 155, 138, 0.3);">
                  <i class="fas fa-envelope"></i>
                </a>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      {% endif %}
    </div>
  </div>
</section>

<!-- CTA: Ready to Partner -->
<section class="py-5 bg-gradient-light">
  <div class="container">
    <div class="row align-items-center text-center">
      <div class="col-lg-8 mx-auto" data-aos="fade-up">
        <h2 class="display-6 english-heading mb-3">{% if is_rtl %}جاهز للتعاون معنا؟{% else %}Ready to Partner with Us?{% endif %}</h2>
        <p class="lead text-muted mb-4">{% if is_rtl %}تواصل معنا الآن واكتشف حلول التوريد الموثوقة لأسواقك العالمية.{% else %}Get in touch and discover reliable sourcing solutions for your markets.{% endif %}</p>
        <div class="d-flex flex-wrap justify-content-center gap-3">
          <a href="{{ url_for('main.contact') }}" class="btn btn-primary btn-lg px-5 py-3 hover-lift"><i class="fas fa-envelope me-2"></i>{% if is_rtl %}تواصل الآن{% else %}Contact Us{% endif %}</a>
          <a href="{{ url_for('main.products') }}" class="btn btn-outline-primary btn-lg px-5 py-3 hover-lift"><i class="fas fa-leaf me-2"></i>{% if is_rtl %}تصفح المنتجات{% else %}View Products{% endif %}</a>
        </div>
      </div>
    </div>
  </div>
</section>


{% endblock %}

