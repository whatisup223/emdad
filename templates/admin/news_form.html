{% extends "admin/base.html" %}

{% block title %}
{% if news_item %}{{ _('Edit Article') }}{% else %}{{ _('Add Article') }}{% endif %} - {{ _('Admin Panel') }}
{% endblock %}

{% block extra_css %}
<!-- TinyMCE Editor -->
<script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
<!-- Date Picker -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<style>
.news-form-container {
    background: #f8f9fa;
    min-height: 100vh;
    padding: 2rem 0;
}

.form-card {
    border: none;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.form-header {
    background: #007bff;
    color: white;
    padding: 1.5rem;
    border-radius: 8px 8px 0 0;
}

.form-body {
    padding: 2rem;
}

.form-floating > .form-control {
    border: 1px solid #ced4da;
    border-radius: 6px;
}

.form-floating > .form-control:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.nav-tabs .nav-link {
    border: none;
    border-radius: 6px 6px 0 0;
    background: #f8f9fa;
    color: #6c757d;
    margin-right: 5px;
    padding: 12px 20px;
}

.nav-tabs .nav-link.active {
    background: white;
    color: #495057;
    border: 1px solid #dee2e6;
    border-bottom: 1px solid white;
}

.tab-content {
    background: white;
    border: 1px solid #dee2e6;
    border-top: none;
    border-radius: 0 6px 6px 6px;
    padding: 1.5rem;
}

.char-counter {
    font-size: 0.8rem;
    color: #6c757d;
    text-align: right;
    margin-top: 0.25rem;
}

.char-counter.warning {
    color: #fd7e14;
}

.char-counter.danger {
    color: #dc3545;
}

.btn {
    border-radius: 6px;
    font-weight: 500;
}

.btn-primary {
    background-color: #007bff;
    border-color: #007bff;
}

.btn-primary:hover {
    background-color: #0056b3;
    border-color: #004085;
}

.tox-tinymce {
    border-radius: 6px !important;
    border: 1px solid #ced4da !important;
}

.tox-tinymce:focus-within {
    border-color: #007bff !important;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25) !important;
}

.tox-toolbar {
    background: #f8f9fa !important;
}

@media (max-width: 768px) {
    .news-form-container {
        padding: 1rem 0;
    }
    
    .form-body {
        padding: 1rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="news-form-container">
    <div class="container-fluid">
        <div class="row justify-content-center">
            <div class="col-12 col-lg-10">
                
                <!-- Page Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="mb-1">
                            <i class="fas fa-newspaper text-primary me-2"></i>
                            {% if news_item %}{{ _('Edit Article') }}{% else %}{{ _('Add New Article') }}{% endif %}
                        </h2>
                        <p class="text-muted mb-0">{{ _('Create and manage news articles') }}</p>
                    </div>
                    <a href="{{ url_for('admin.news') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>{{ _('Back to News') }}
                    </a>
                </div>

                <!-- Main Form -->
                <div class="card form-card">
                    <div class="card-header form-header">
                        <h5 class="mb-0">
                            <i class="fas fa-edit me-2"></i>{{ _('Article Details') }}
                        </h5>
                    </div>

                    <div class="card-body form-body">
                        <form method="POST" enctype="multipart/form-data" id="newsForm">
                            {{ form.hidden_tag() }}
                            
                            <!-- Basic Information -->
                            <div class="row mb-4">
                                <div class="col-md-8">
                                    <div class="form-floating mb-3">
                                        {{ form.title_en(class="form-control", placeholder=_("Enter article title")) }}
                                        <label for="title_en" class="form-label">{{ _('Title') }} ({{ _('English') }})</label>
                                        {% if form.title_en.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.title_en.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                        <div class="char-counter" id="title-counter">0/200</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-floating mb-3">
                                        {{ form.slug(class="form-control", placeholder=_("article-url-slug")) }}
                                        <label for="slug" class="form-label">{{ _('URL Slug') }}</label>
                                        {% if form.slug.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.slug.errors %}{{ error }}{% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <!-- Excerpt -->
                            <div class="form-floating mb-4">
                                {{ form.excerpt_en(class="form-control", placeholder=_("Brief description"), rows="3") }}
                                <label for="excerpt_en" class="form-label">{{ _('Excerpt') }} ({{ _('English') }})</label>
                                {% if form.excerpt_en.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.excerpt_en.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                                <div class="char-counter" id="excerpt-counter">0/500</div>
                            </div>

                            <!-- Content Tabs -->
                            <div class="mb-4">
                                <ul class="nav nav-tabs" id="contentTabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="english-tab" data-bs-toggle="tab"
                                                data-bs-target="#english" type="button" role="tab">
                                            <i class="fas fa-globe me-1"></i>{{ _('English Content') }}
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="arabic-tab" data-bs-toggle="tab"
                                                data-bs-target="#arabic" type="button" role="tab">
                                            <i class="fas fa-globe me-1"></i>{{ _('Arabic Content') }}
                                        </button>
                                    </li>
                                </ul>

                                <div class="tab-content" id="contentTabsContent">
                                    <!-- English Content -->
                                    <div class="tab-pane fade show active" id="english" role="tabpanel">
                                        <div class="mb-3">
                                            <label for="title_ar" class="form-label">{{ _('Title') }} ({{ _('Arabic') }})</label>
                                            {{ form.title_ar(class="form-control", placeholder=_("Enter article title"), dir="rtl") }}
                                            {% if form.title_ar.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {% for error in form.title_ar.errors %}{{ error }}{% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>

                                        <div class="mb-3">
                                            <label for="excerpt_ar" class="form-label">{{ _('Excerpt') }} ({{ _('Arabic') }})</label>
                                            {{ form.excerpt_ar(class="form-control", placeholder=_("Brief description"), rows="3", dir="rtl") }}
                                            {% if form.excerpt_ar.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {% for error in form.excerpt_ar.errors %}{{ error }}{% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>

                                        <div class="mb-3">
                                            <label for="content_en" class="form-label">{{ _('Content') }} ({{ _('English') }})</label>
                                            {{ form.content_en(class="form-control rich-editor", id="content_en") }}
                                            {% if form.content_en.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {% for error in form.content_en.errors %}{{ error }}{% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <!-- Arabic Content -->
                                    <div class="tab-pane fade" id="arabic" role="tabpanel">
                                        <div class="mb-3">
                                            <label for="content_ar" class="form-label">{{ _('Content') }} ({{ _('Arabic') }})</label>
                                            {{ form.content_ar(class="form-control rich-editor", id="content_ar", dir="rtl") }}
                                            {% if form.content_ar.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {% for error in form.content_ar.errors %}{{ error }}{% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Publishing Options -->
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="form-floating mb-3">
                                        {{ form.status(class="form-select") }}
                                        <label for="status" class="form-label">{{ _('Status') }}</label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-floating mb-3">
                                        {{ form.publish_at(class="form-control datetime-picker", placeholder=_("Select date")) }}
                                        <label for="publish_at" class="form-label">{{ _('Publish Date') }}</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-floating mb-3">
                                        {{ form.tags(class="form-control", placeholder=_("tag1, tag2, tag3")) }}
                                        <label for="tags" class="form-label">{{ _('Tags') }}</label>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-check mt-4">
                                        {{ form.featured(class="form-check-input") }}
                                        <label for="featured" class="form-check-label">{{ _('Featured') }}</label>
                                    </div>
                                </div>
                            </div>

                            <!-- Cover Image -->
                            <div class="mb-4">
                                <label for="cover_image" class="form-label">{{ _('Cover Image') }}</label>
                                {{ form.cover_image(class="form-control") }}
                                {% if form.cover_image.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.cover_image.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                                {% if news_item and news_item.cover_image %}
                                    <div class="mt-2">
                                        <small class="text-muted">{{ _('Current Image') }}:</small><br>
                                        <img src="{{ url_for('main.uploaded_file', filename='news/' + news_item.cover_image) }}"
                                             alt="{{ news_item.title_en }}" class="img-thumbnail" style="max-width: 200px;">
                                    </div>
                                {% endif %}
                                <div class="form-text">{{ _('Upload cover image (JPG, PNG, WebP - Max 5MB)') }}</div>
                            </div>

                            <!-- Form Actions -->
                            <div class="d-flex justify-content-between align-items-center pt-3 border-top">
                                <div>
                                    <span class="badge bg-secondary me-2">{{ _('Draft') }}</span>
                                    <small class="text-muted">{{ _('Auto-save: Enabled') }}</small>
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="submit" name="action" value="draft" class="btn btn-outline-primary">
                                        <i class="fas fa-save me-1"></i>{{ _('Save Draft') }}
                                    </button>
                                    <button type="submit" name="action" value="publish" class="btn btn-primary">
                                        <i class="fas fa-paper-plane me-1"></i>{{ _('Publish') }}
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Date Picker -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize TinyMCE Rich Text Editor
    tinymce.init({
        selector: '.rich-editor',
        height: 400,
        menubar: true,
        plugins: [
            'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
            'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
            'insertdatetime', 'media', 'table', 'help', 'wordcount'
        ],
        toolbar: 'undo redo | blocks | ' +
            'bold italic backcolor | alignleft aligncenter ' +
            'alignright alignjustify | bullist numlist outdent indent | ' +
            'removeformat | help',
        content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, San Francisco, Segoe UI, Roboto, Helvetica Neue, sans-serif; font-size: 14px; }',
        branding: false,
        promotion: false,
        setup: function (editor) {
            editor.on('change', function () {
                editor.save();
            });
        },
        directionality: function(element) {
            return element.getAttribute('dir') === 'rtl' ? 'rtl' : 'ltr';
        }
    });

    // Initialize date/time picker
    const publishField = document.querySelector('.datetime-picker');
    if (publishField) {
        flatpickr(publishField, {
            enableTime: true,
            dateFormat: "Y-m-d H:i:S",
            time_24hr: true,
            defaultDate: "{{ news_item.publish_at.strftime('%Y-%m-%d %H:%M:%S') if news_item and news_item.publish_at else '' }}",
            locale: {
                firstDayOfWeek: 1
            },
            allowInput: true
        });
    }

    // Character counters
    function updateCharCounter(input, counterId, maxLength) {
        const counter = document.getElementById(counterId);
        if (!counter) return;

        const length = input.value.length;
        counter.textContent = `${length}/${maxLength}`;

        counter.className = 'char-counter';
        if (length > maxLength * 0.9) {
            counter.classList.add('danger');
        } else if (length > maxLength * 0.7) {
            counter.classList.add('warning');
        }
    }

    // Setup character counters
    const titleInput = document.getElementById('title_en');
    const excerptInput = document.getElementById('excerpt_en');

    if (titleInput) {
        titleInput.addEventListener('input', () => updateCharCounter(titleInput, 'title-counter', 200));
        updateCharCounter(titleInput, 'title-counter', 200); // Initial count
    }

    if (excerptInput) {
        excerptInput.addEventListener('input', () => updateCharCounter(excerptInput, 'excerpt-counter', 500));
        updateCharCounter(excerptInput, 'excerpt-counter', 500); // Initial count
    }

    // Auto-generate slug from title
    if (titleInput) {
        titleInput.addEventListener('input', function() {
            const slug = this.value
                .toLowerCase()
                .replace(/[^a-z0-9\s-]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .trim('-');
            const slugField = document.getElementById('slug');
            if (slugField && !slugField.value) {
                slugField.value = slug;
            }
        });
    }

    // Form validation
    const form = document.getElementById('newsForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            const titleEn = document.getElementById('title_en').value.trim();
            const contentEn = tinymce.get('content_en') ? tinymce.get('content_en').getContent() : '';

            if (!titleEn) {
                e.preventDefault();
                alert('{{ _("Please enter an English title") }}');
                return false;
            }

            if (!contentEn || contentEn.length < 50) {
                e.preventDefault();
                alert('{{ _("Please enter article content (minimum 50 characters)") }}');
                return false;
            }
        });
    }
});
</script>
{% endblock %}
