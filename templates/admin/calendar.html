{% extends 'admin/base.html' %}
{% block title %}Calendar{% endblock %}
{% block content %}
<div class="container-fluid">
  <div class="d-flex align-items-center justify-content-between mb-4 flex-wrap gap-2">
    <h1 class="h3 mb-0">{{ 'تقويم المواسم' if is_rtl else 'Seasonality Calendar' }}</h1>
    <div class="text-muted small">{{ 'انقر على الخلايا لتغيير الحالة: خارج الموسم - محدود - متاح - ذروة - مجمّد' if is_rtl else 'Click cells to cycle state: Off - Limited - Available - Peak - Frozen' }}</div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <div class="mb-3 d-flex flex-column flex-md-row gap-2">
        <select id="categoryFilter" class="form-select" style="max-width:260px">
          <option value="">{{ 'كل الفئات' if is_rtl else 'All Categories' }}</option>
          {% for c in categories %}<option value="{{ c.id }}">{{ c.get_name(get_locale()) }}</option>{% endfor %}
        </select>
        <input id="searchInput" class="form-control" placeholder="{{ 'ابحث عن منتج' if is_rtl else 'Search product' }}">
        <button id="toggleView" class="btn btn-outline-secondary d-md-none">
          <i class="fas fa-mobile-alt"></i> {{ 'عرض الموبايل' if is_rtl else 'Mobile View' }}
        </button>
      </div>

      <!-- Desktop Table View -->
      <div class="table-responsive d-none d-lg-block" id="desktopView">
        <table class="table align-middle mb-0" id="calendarTable">
          <thead class="table-light">
            <tr>
              <th style="min-width:240px">Product</th>
              {% set months_names_en = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'] %}
              {% set months_names_ar = ['يناير','فبراير','مارس','أبريل','مايو','يونيو','يوليو','أغسطس','سبتمبر','أكتوبر','نوفمبر','ديسمبر'] %}
              {% for i in range(1,13) %}
                <th class="text-center" style="width:64px">{{ months_names_ar[i-1] if is_rtl else months_names_en[i-1] }}</th>
              {% endfor %}
              <th class="text-center" style="width:100px">{{ 'إجراءات' if is_rtl else 'Actions' }}</th>
            </tr>
          </thead>
          <tbody>
            {% for p in products %}
            {% set data = p.get_seasonality_lang(get_locale()) %}
            {% if 'fresh' in data %}{% set data = data['fresh'] %}{% endif %}
            <tr data-product-id="{{ p.id }}" data-category-id="{{ p.category_id }}" data-save-url="{{ url_for('admin.calendar_save', product_id=p.id) }}">
              <td>
                <div class="fw-semibold d-flex align-items-center gap-2">
                  {{ p.get_name(get_locale()) }}
                </div>
                <div class="text-muted small">{{ p.category.get_name(get_locale()) if p.category }}</div>
              </td>
              {% for i in range(1,13) %}
                {% set s='off' %}
                {% if data and i in (data.get('peak') or []) %}{% set s='peak' %}
                {% elif data and i in (data.get('available') or []) %}{% set s='available' %}
                {% elif data and i in (data.get('limited') or []) %}{% set s='limited' %}
                {% elif data and i in (data.get('iqf') or []) %}{% set s='iqf' %}
                {% endif %}
                <td class="text-center">
                  <button class="cell btn btn-sm state-{{ s }}" data-month="{{ i }}" aria-label="{{ i }}"></button>
                </td>
              {% endfor %}
              <td class="text-center">
                <button class="btn btn-outline-primary btn-sm save-row">{{ 'حفظ' if is_rtl else 'Save' }}</button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Mobile Card View -->
      <div class="d-lg-none" id="mobileView">
        {% for p in products %}
        {% set data = p.get_seasonality_lang(get_locale()) %}
        {% if 'fresh' in data %}{% set data = data['fresh'] %}{% endif %}
        <div class="card mb-3 product-card" data-product-id="{{ p.id }}" data-category-id="{{ p.category_id }}" data-save-url="{{ url_for('admin.calendar_save', product_id=p.id) }}">
          <div class="card-header d-flex justify-content-between align-items-center">
            <div>
              <h6 class="mb-0 fw-semibold">{{ p.get_name(get_locale()) }}</h6>
              <small class="text-muted">{{ p.category.get_name(get_locale()) if p.category }}</small>
            </div>
            <button class="btn btn-outline-primary btn-sm save-row-mobile">{{ 'حفظ' if is_rtl else 'Save' }}</button>
          </div>
          <div class="card-body">
            <div class="row g-2">
              {% for i in range(1,13) %}
                {% set s='off' %}
                {% if data and i in (data.get('peak') or []) %}{% set s='peak' %}
                {% elif data and i in (data.get('available') or []) %}{% set s='available' %}
                {% elif data and i in (data.get('limited') or []) %}{% set s='limited' %}
                {% elif data and i in (data.get('iqf') or []) %}{% set s='iqf' %}
                {% endif %}
                <div class="col-3 col-sm-2">
                  <div class="text-center">
                    <div class="small text-muted mb-1">{{ months_names_ar[i-1] if is_rtl else months_names_en[i-1] }}</div>
                    <button class="cell-mobile btn btn-sm state-{{ s }} w-100" data-month="{{ i }}" aria-label="{{ i }}"></button>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <div class="mt-3">
        <div class="d-flex flex-column flex-md-row align-items-start align-md-center justify-content-between gap-3">
          <div class="d-flex flex-wrap align-items-center gap-3">
            <div class="d-flex align-items-center gap-2">
              <span class="legend l-peak"></span>
              <span class="small">{{ 'ذروة' if is_rtl else 'Peak' }}</span>
            </div>
            <div class="d-flex align-items-center gap-2">
              <span class="legend l-available"></span>
              <span class="small">{{ 'متاح' if is_rtl else 'Available' }}</span>
            </div>
            <div class="d-flex align-items-center gap-2">
              <span class="legend l-limited"></span>
              <span class="small">{{ 'محدود' if is_rtl else 'Limited' }}</span>
            </div>
            <div class="d-flex align-items-center gap-2">
              <span class="legend l-off"></span>
              <span class="small">{{ 'خارج الموسم' if is_rtl else 'Off' }}</span>
            </div>
            <div class="d-flex align-items-center gap-2">
              <span class="legend" style="background:#5bc0de; border-color:#5bc0de;"></span>
              <span class="small">{{ 'مجمّد' if is_rtl else 'Frozen' }}</span>
            </div>
          </div>
          <button id="saveAll" class="btn btn-success">
            <i class="fas fa-save me-1"></i>
            {{ 'حفظ الكل' if is_rtl else 'Save All' }}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* Desktop Table Styles */
  #calendarTable .cell {
    width:32px;
    height:24px;
    border-radius:6px;
    border:1px solid #e5e7eb;
    padding:0;
    transition: all 0.2s ease;
  }

  #calendarTable .cell:hover {
    transform: scale(1.1);
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }

  /* Mobile Card Styles */
  .cell-mobile {
    height:40px;
    border-radius:8px;
    border:2px solid #e5e7eb;
    padding:0;
    transition: all 0.2s ease;
    position: relative;
  }

  .cell-mobile:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }

  /* State Colors */
  .state-peak{
    background:#2c5f4f;
    border-color:#2c5f4f;
    color: white;
  } /* dark green */

  .state-available{
    background:#689b8a;
    border-color:#689b8a;
    color: white;
  } /* primary green */

  .state-limited{
    background:#f9cb99;
    border-color:#f9cb99;
    color: #856404;
  } /* peach */

  .state-off{
    background:#adb5bd;
    border-color:#adb5bd;
    color: white;
  } /* gray */

  .state-iqf{
    background:#5bc0de;
    border-color:#5bc0de;
    color: white;
  } /* blue for frozen */

  /* Legend Styles */
  .legend{
    width:14px;
    height:14px;
    display:inline-block;
    border-radius:4px;
    border:1px solid #e5e7eb;
  }

  .l-peak{ background:#2c5f4f; border-color:#2c5f4f; }
  .l-available{ background:#689b8a; border-color:#689b8a; }
  .l-limited{ background:#f9cb99; border-color:#f9cb99; }
  .l-off{ background:#adb5bd; border-color:#adb5bd; }

  /* Mobile Product Cards */
  .product-card {
    border: 1px solid #e9ecef;
    transition: all 0.2s ease;
  }

  .product-card:hover {
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    transform: translateY(-2px);
  }

  /* Responsive Adjustments */
  @media (max-width: 768px) {
    .container-fluid {
      padding-left: 1rem;
      padding-right: 1rem;
    }

    .card-body {
      padding: 1rem;
    }

    .cell-mobile {
      height: 35px;
      font-size: 0.8rem;
    }
  }

  @media (max-width: 576px) {
    .cell-mobile {
      height: 30px;
      font-size: 0.75rem;
    }

    .product-card .card-header h6 {
      font-size: 0.9rem;
    }
  }

  /* Hide/Show Views Based on Screen Size */
  @media (min-width: 992px) {
    #mobileView {
      display: none !important;
    }
    #desktopView {
      display: block !important;
    }
  }

  @media (max-width: 991.98px) {
    #desktopView {
      display: none !important;
    }
    #mobileView {
      display: block !important;
    }
  }
</style>

{% raw %}
<script>
// Calendar functionality - Main script
(function(){
  console.log('🚀 Loading calendar main script...');

  // Cycle now includes IQF as a fifth state
  const nextState = { 'off':'limited', 'limited':'available', 'available':'peak', 'peak':'iqf', 'iqf':'off' };

  // Function to handle cell clicks (both desktop and mobile)
  function handleCellClick(btn) {
    const classes = Array.from(btn.classList);
    const current = classes.find(c=>c.startsWith('state-')).replace('state-','');
    const ns = nextState[current] || 'off';
    classes.forEach(c=>{ if(c.startsWith('state-')) btn.classList.remove(c); });
    btn.classList.add('state-'+ns);
  }

  // Desktop table cells
  document.querySelectorAll('#calendarTable .cell').forEach(btn=>{
    btn.addEventListener('click', ()=> handleCellClick(btn));
  });

  // Mobile card cells
  document.querySelectorAll('.cell-mobile').forEach(btn=>{
    btn.addEventListener('click', ()=> handleCellClick(btn));
  });

  // Function to extract payload from row (desktop) or card (mobile) - GLOBAL
  window.rowPayload = function(container){
    const months = {peak:[], available:[], limited:[], off:[], iqf:[]};
    const cells = container.querySelectorAll('.cell, .cell-mobile');

    console.log(`Processing ${cells.length} cells for container`);

    cells.forEach(b=>{
      const m = parseInt(b.dataset.month,10);
      if (isNaN(m) || m < 1 || m > 12) {
        console.warn(`Invalid month value: ${b.dataset.month}`);
        return;
      }

      let s = Array.from(b.classList).find(c=>c.startsWith('state-'));
      s = s ? s.replace('state-','') : 'off';

      if(!months[s]) {
        console.warn(`Unknown state: ${s}, defaulting to 'off'`);
        s = 'off';
      }

      months[s].push(m);
    });

    console.log('Generated payload:', months);
    return months;
  };

  // Desktop save buttons
  document.querySelectorAll('.save-row').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const tr = btn.closest('tr');
      const url = tr.dataset.saveUrl;
      const payload = window.rowPayload(tr);
      const res = await fetch(url,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      const j = await res.json();
      if(j.ok){ window.showSaveSuccess(btn); }
    });
  });

  // Mobile save buttons
  document.querySelectorAll('.save-row-mobile').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const card = btn.closest('.product-card');
      const url = card.dataset.saveUrl;
      const payload = window.rowPayload(card);
      const res = await fetch(url,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      const j = await res.json();
      if(j.ok){ window.showSaveSuccess(btn); }
    });
  });

  // Filters
  const catSel = document.getElementById('categoryFilter');
  const qIn = document.getElementById('searchInput');

  function applyFilters(){
    const cid = catSel.value;
    const q = qIn.value.toLowerCase();

    // Filter desktop table rows
    document.querySelectorAll('#calendarTable tbody tr').forEach(tr=>{
      const matchCat = !cid || tr.dataset.categoryId === cid;
      const name = tr.querySelector('td .fw-semibold')?.textContent.toLowerCase() || '';
      const matchQ = !q || name.includes(q);
      tr.style.display = (matchCat && matchQ) ? '' : 'none';
    });

    // Filter mobile cards
    document.querySelectorAll('.product-card').forEach(card=>{
      const matchCat = !cid || card.dataset.categoryId === cid;
      const name = card.querySelector('.card-header h6')?.textContent.toLowerCase() || '';
      const matchQ = !q || name.includes(q);
      card.style.display = (matchCat && matchQ) ? '' : 'none';
    });
  }

  catSel.addEventListener('change', applyFilters);
  qIn.addEventListener('input', applyFilters);

  console.log('✅ Calendar main script loaded successfully');
})();
</script>
{% endraw %}

<script>
// Jinja2 template variables for JavaScript - Using safe encoding
const isRtl = {% if is_rtl %}true{% else %}false{% endif %};
const saveText = {% if is_rtl %}"حفظ"{% else %}"Save"{% endif %};
const savedText = {% if is_rtl %}"تم الحفظ"{% else %}"Saved"{% endif %};
const savingText = {% if is_rtl %}"جاري الحفظ..."{% else %}"Saving..."{% endif %};
const allSavedText = {% if is_rtl %}"تم حفظ جميع المنتجات بنجاح"{% else %}"All products saved successfully"{% endif %};
const desktopViewText = {% if is_rtl %}"عرض سطح المكتب"{% else %}"Desktop View"{% endif %};
const mobileViewText = {% if is_rtl %}"عرض الموبايل"{% else %}"Mobile View"{% endif %};

// Update save success feedback function - GLOBAL
window.showSaveSuccess = function(btn) {
  btn.classList.replace('btn-outline-primary','btn-success');
  btn.textContent = savedText;
  setTimeout(()=>{
    btn.classList.replace('btn-success','btn-outline-primary');
    btn.textContent = saveText;
  }, 1200);
};

// Save All functionality - Completely rewritten for reliability
window.initSaveAllButton = function() {
  console.log('🔧 Initializing Save All button...');

  const saveAllBtn = document.getElementById('saveAll');

  if (!saveAllBtn) {
    console.error('❌ Save All button not found!');
    return false;
  }

  console.log('✅ Save All button found:', saveAllBtn);

  // Clear any existing listeners
  saveAllBtn.onclick = null;

  // Add new click handler
  saveAllBtn.onclick = async function(event) {
    event.preventDefault();
    event.stopPropagation();

    console.log('🚀 Save All button clicked!');

    const btn = this;
    const originalText = btn.textContent;
    const originalClass = btn.className;

    try {
      // Disable button and show loading state
      btn.disabled = true;
      btn.textContent = savingText;
      btn.className = 'btn btn-warning';

      console.log('🚀 Starting Save All operation...');

      // Get all containers
      const desktopRows = Array.from(document.querySelectorAll('#calendarTable tbody tr[data-save-url]'));
      const mobileCards = Array.from(document.querySelectorAll('.product-card[data-save-url]'));

      // Choose active containers based on screen size
      const isDesktop = window.innerWidth >= 992;
      const containers = isDesktop ? desktopRows : mobileCards;

      console.log(`📊 Found ${containers.length} containers (${isDesktop ? 'desktop' : 'mobile'} view)`);

      if (containers.length === 0) {
        throw new Error('No products found to save');
      }

      let successCount = 0;
      let errorCount = 0;
      const errors = [];

      // Process each container
      for (let i = 0; i < containers.length; i++) {
        const container = containers[i];

        try {
          const url = container.dataset.saveUrl;
          if (!url) {
            throw new Error(`No save URL for container ${i + 1}`);
          }

          const payload = window.rowPayload(container);
          console.log(`💾 Saving ${i + 1}/${containers.length}: ${url}`);

          const response = await fetch(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(payload)
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const result = await response.json();
          if (!result.ok) {
            throw new Error(`Server error: ${JSON.stringify(result)}`);
          }

          successCount++;
          console.log(`✅ Saved ${i + 1}/${containers.length}`);

        } catch (error) {
          errorCount++;
          errors.push(`Product ${i + 1}: ${error.message}`);
          console.error(`❌ Error saving product ${i + 1}:`, error);
        }
      }

      // Show results
      console.log(`📈 Save All completed: ${successCount} success, ${errorCount} errors`);

      if (errorCount === 0) {
        btn.className = 'btn btn-success';
        btn.textContent = '✅ All Saved!';
        alert(allSavedText);
      } else {
        btn.className = 'btn btn-danger';
        btn.textContent = `❌ ${errorCount} Failed`;
        const errorMsg = `Saved ${successCount} products successfully.\n${errorCount} products failed:\n\n${errors.slice(0, 5).join('\n')}`;
        alert(errorMsg);
      }

    } catch (error) {
      console.error('💥 Save All operation failed:', error);
      btn.className = 'btn btn-danger';
      btn.textContent = '❌ Failed';
      alert(`Save All failed: ${error.message}`);
    }

    // Reset button after delay
    setTimeout(() => {
      btn.disabled = false;
      btn.textContent = originalText;
      btn.className = originalClass;
    }, 3000);
  };

  console.log('✅ Save All button initialized successfully');
  return true;
};

// Initialize Save All button - Multiple attempts for reliability
function tryInitSaveAll() {
  console.log('🔄 Attempting to initialize Save All button...');
  if (window.initSaveAllButton && window.initSaveAllButton()) {
    console.log('✅ Save All button initialized successfully');
    return true;
  }
  return false;
}

// Try immediately if DOM is ready
if (document.readyState !== 'loading') {
  setTimeout(tryInitSaveAll, 100);
}

// Try when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
  console.log('📄 DOM loaded');
  setTimeout(tryInitSaveAll, 100);
});

// Try when window is loaded (fallback)
window.addEventListener('load', function() {
  console.log('🌐 Window loaded');
  setTimeout(tryInitSaveAll, 100);
});

// Toggle view functionality
const toggleBtn = document.getElementById('toggleView');
if (toggleBtn) {
  let isMobileView = window.innerWidth < 992;

  function updateToggleButton() {
    if (isMobileView) {
      toggleBtn.innerHTML = '<i class="fas fa-desktop"></i> ' + desktopViewText;
    } else {
      toggleBtn.innerHTML = '<i class="fas fa-mobile-alt"></i> ' + mobileViewText;
    }
  }

  function toggleViews() {
    const desktopView = document.getElementById('desktopView');
    const mobileView = document.getElementById('mobileView');

    if (isMobileView) {
      desktopView.classList.remove('d-none');
      mobileView.classList.add('d-none');
      desktopView.style.overflowX = 'auto';
    } else {
      desktopView.classList.add('d-none');
      mobileView.classList.remove('d-none');
    }

    isMobileView = !isMobileView;
    updateToggleButton();
  }

  updateToggleButton();
  toggleBtn.addEventListener('click', toggleViews);

  // Handle window resize
  window.addEventListener('resize', function() {
    if (window.innerWidth >= 992) {
      // Large screens - always show desktop view
      document.getElementById('desktopView').classList.remove('d-none');
      document.getElementById('mobileView').classList.add('d-none');
      toggleBtn.style.display = 'none';
    } else {
      // Small/medium screens - show toggle button
      toggleBtn.style.display = 'block';
    }
  });
}
</script>
{% endblock %}

