{% extends 'admin/base.html' %}
{% block title %}Calendar{% endblock %}
{% block content %}
<div class="container-fluid">
  <div class="d-flex align-items-center justify-content-between mb-4 flex-wrap gap-2">
    <h1 class="h3 mb-0">{{ 'تقويم المواسم' if is_rtl else 'Seasonality Calendar' }}</h1>
    <div class="text-muted small">{{ 'انقر على الخلايا لتغيير الحالة: خارج الموسم → محدود → متاح → ذروة → مجمّد' if is_rtl else 'Click cells to cycle state: Off → Limited → Available → Peak → Frozen' }}</div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <div class="mb-3 d-flex flex-column flex-md-row gap-2">
        <select id="categoryFilter" class="form-select" style="max-width:260px">
          <option value="">{{ 'كل الفئات' if is_rtl else 'All Categories' }}</option>
          {% for c in categories %}<option value="{{ c.id }}">{{ c.get_name(get_locale()) }}</option>{% endfor %}
        </select>
        <input id="searchInput" class="form-control" placeholder="{{ 'ابحث عن منتج' if is_rtl else 'Search product' }}">
        <button id="toggleView" class="btn btn-outline-secondary d-md-none">
          <i class="fas fa-mobile-alt"></i> {{ 'عرض الموبايل' if is_rtl else 'Mobile View' }}
        </button>
      </div>

      <!-- Desktop Table View -->
      <div class="table-responsive d-none d-lg-block" id="desktopView">
        <table class="table align-middle mb-0" id="calendarTable">
          <thead class="table-light">
            <tr>
              <th style="min-width:240px">Product</th>
              {% set months_names_en = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'] %}
              {% set months_names_ar = ['يناير','فبراير','مارس','أبريل','مايو','يونيو','يوليو','أغسطس','سبتمبر','أكتوبر','نوفمبر','ديسمبر'] %}
              {% for i in range(1,13) %}
                <th class="text-center" style="width:64px">{{ months_names_ar[i-1] if is_rtl else months_names_en[i-1] }}</th>
              {% endfor %}
              <th class="text-center" style="width:100px">{{ 'إجراءات' if is_rtl else 'Actions' }}</th>
            </tr>
          </thead>
          <tbody>
            {% for p in products %}
            {% set data = p.get_seasonality_lang(get_locale()) %}
            {% if 'fresh' in data %}{% set data = data['fresh'] %}{% endif %}
            <tr data-product-id="{{ p.id }}" data-category-id="{{ p.category_id }}" data-save-url="{{ url_for('admin.calendar_save', product_id=p.id) }}">
              <td>
                <div class="fw-semibold d-flex align-items-center gap-2">
                  {{ p.get_name(get_locale()) }}
                </div>
                <div class="text-muted small">{{ p.category.get_name(get_locale()) if p.category }}</div>
              </td>
              {% for i in range(1,13) %}
                {% set s='off' %}
                {% if data and i in (data.get('peak') or []) %}{% set s='peak' %}
                {% elif data and i in (data.get('available') or []) %}{% set s='available' %}
                {% elif data and i in (data.get('limited') or []) %}{% set s='limited' %}
                {% elif data and i in (data.get('iqf') or []) %}{% set s='iqf' %}
                {% endif %}
                <td class="text-center">
                  <button class="cell btn btn-sm state-{{ s }}" data-month="{{ i }}" aria-label="{{ i }}"></button>
                </td>
              {% endfor %}
              <td class="text-center">
                <button class="btn btn-outline-primary btn-sm save-row">{{ 'حفظ' if is_rtl else 'Save' }}</button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Mobile Card View -->
      <div class="d-lg-none" id="mobileView">
        {% for p in products %}
        {% set data = p.get_seasonality_lang(get_locale()) %}
        {% if 'fresh' in data %}{% set data = data['fresh'] %}{% endif %}
        <div class="card mb-3 product-card" data-product-id="{{ p.id }}" data-category-id="{{ p.category_id }}" data-save-url="{{ url_for('admin.calendar_save', product_id=p.id) }}">
          <div class="card-header d-flex justify-content-between align-items-center">
            <div>
              <h6 class="mb-0 fw-semibold">{{ p.get_name(get_locale()) }}</h6>
              <small class="text-muted">{{ p.category.get_name(get_locale()) if p.category }}</small>
            </div>
            <button class="btn btn-outline-primary btn-sm save-row-mobile">{{ 'حفظ' if is_rtl else 'Save' }}</button>
          </div>
          <div class="card-body">
            <div class="row g-2">
              {% for i in range(1,13) %}
                {% set s='off' %}
                {% if data and i in (data.get('peak') or []) %}{% set s='peak' %}
                {% elif data and i in (data.get('available') or []) %}{% set s='available' %}
                {% elif data and i in (data.get('limited') or []) %}{% set s='limited' %}
                {% elif data and i in (data.get('iqf') or []) %}{% set s='iqf' %}
                {% endif %}
                <div class="col-3 col-sm-2">
                  <div class="text-center">
                    <div class="small text-muted mb-1">{{ months_names_ar[i-1] if is_rtl else months_names_en[i-1] }}</div>
                    <button class="cell-mobile btn btn-sm state-{{ s }} w-100" data-month="{{ i }}" aria-label="{{ i }}"></button>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <div class="mt-3">
        <div class="d-flex flex-column flex-md-row align-items-start align-md-center justify-content-between gap-3">
          <div class="d-flex flex-wrap align-items-center gap-3">
            <div class="d-flex align-items-center gap-2">
              <span class="legend l-peak"></span>
              <span class="small">{{ 'ذروة' if is_rtl else 'Peak' }}</span>
            </div>
            <div class="d-flex align-items-center gap-2">
              <span class="legend l-available"></span>
              <span class="small">{{ 'متاح' if is_rtl else 'Available' }}</span>
            </div>
            <div class="d-flex align-items-center gap-2">
              <span class="legend l-limited"></span>
              <span class="small">{{ 'محدود' if is_rtl else 'Limited' }}</span>
            </div>
            <div class="d-flex align-items-center gap-2">
              <span class="legend l-off"></span>
              <span class="small">{{ 'خارج الموسم' if is_rtl else 'Off' }}</span>
            </div>
            <div class="d-flex align-items-center gap-2">
              <span class="legend" style="background:#5bc0de; border-color:#5bc0de;"></span>
              <span class="small">{{ 'مجمّد' if is_rtl else 'Frozen' }}</span>
            </div>
          </div>
          <button id="saveAll" class="btn btn-success">
            <i class="fas fa-save me-1"></i>
            {{ 'حفظ الكل' if is_rtl else 'Save All' }}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* Desktop Table Styles */
  #calendarTable .cell {
    width:32px;
    height:24px;
    border-radius:6px;
    border:1px solid #e5e7eb;
    padding:0;
    transition: all 0.2s ease;
  }

  #calendarTable .cell:hover {
    transform: scale(1.1);
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }

  /* Mobile Card Styles */
  .cell-mobile {
    height:40px;
    border-radius:8px;
    border:2px solid #e5e7eb;
    padding:0;
    transition: all 0.2s ease;
    position: relative;
  }

  .cell-mobile:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }

  /* State Colors */
  .state-peak{
    background:#2c5f4f;
    border-color:#2c5f4f;
    color: white;
  } /* dark green */

  .state-available{
    background:#689b8a;
    border-color:#689b8a;
    color: white;
  } /* primary green */

  .state-limited{
    background:#f9cb99;
    border-color:#f9cb99;
    color: #856404;
  } /* peach */

  .state-off{
    background:#adb5bd;
    border-color:#adb5bd;
    color: white;
  } /* gray */

  .state-iqf{
    background:#5bc0de;
    border-color:#5bc0de;
    color: white;
  } /* blue for frozen */

  /* Legend Styles */
  .legend{
    width:14px;
    height:14px;
    display:inline-block;
    border-radius:4px;
    border:1px solid #e5e7eb;
  }

  .l-peak{ background:#2c5f4f; border-color:#2c5f4f; }
  .l-available{ background:#689b8a; border-color:#689b8a; }
  .l-limited{ background:#f9cb99; border-color:#f9cb99; }
  .l-off{ background:#adb5bd; border-color:#adb5bd; }

  /* Mobile Product Cards */
  .product-card {
    border: 1px solid #e9ecef;
    transition: all 0.2s ease;
  }

  .product-card:hover {
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    transform: translateY(-2px);
  }

  /* Responsive Adjustments */
  @media (max-width: 768px) {
    .container-fluid {
      padding-left: 1rem;
      padding-right: 1rem;
    }

    .card-body {
      padding: 1rem;
    }

    .cell-mobile {
      height: 35px;
      font-size: 0.8rem;
    }
  }

  @media (max-width: 576px) {
    .cell-mobile {
      height: 30px;
      font-size: 0.75rem;
    }

    .product-card .card-header h6 {
      font-size: 0.9rem;
    }
  }

  /* Hide/Show Views Based on Screen Size */
  @media (min-width: 992px) {
    #mobileView {
      display: none !important;
    }
    #desktopView {
      display: block !important;
    }
  }

  @media (max-width: 991.98px) {
    #desktopView {
      display: none !important;
    }
    #mobileView {
      display: block !important;
    }
  }
</style>

{% raw %}
<script>
(function(){
  // Cycle now includes IQF as a fifth state
  const nextState = { 'off':'limited', 'limited':'available', 'available':'peak', 'peak':'iqf', 'iqf':'off' };

  // Function to handle cell clicks (both desktop and mobile)
  function handleCellClick(btn) {
    const classes = Array.from(btn.classList);
    const current = classes.find(c=>c.startsWith('state-')).replace('state-','');
    const ns = nextState[current] || 'off';
    classes.forEach(c=>{ if(c.startsWith('state-')) btn.classList.remove(c); });
    btn.classList.add('state-'+ns);
  }

  // Desktop table cells
  document.querySelectorAll('#calendarTable .cell').forEach(btn=>{
    btn.addEventListener('click', ()=> handleCellClick(btn));
  });

  // Mobile card cells
  document.querySelectorAll('.cell-mobile').forEach(btn=>{
    btn.addEventListener('click', ()=> handleCellClick(btn));
  });

  // Function to extract payload from row (desktop) or card (mobile)
  function rowPayload(container){
    const months = {peak:[], available:[], limited:[], off:[], iqf:[]};
    const cells = container.querySelectorAll('.cell, .cell-mobile');
    cells.forEach(b=>{
      const m = parseInt(b.dataset.month,10);
      let s = Array.from(b.classList).find(c=>c.startsWith('state-'));
      s = s ? s.replace('state-','') : 'off';
      if(!months[s]) months[s] = [];
      months[s].push(m);
    });
    return months;
  }

  // Desktop save buttons
  document.querySelectorAll('.save-row').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const tr = btn.closest('tr');
      const url = tr.dataset.saveUrl;
      const payload = rowPayload(tr);
      const res = await fetch(url,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      const j = await res.json();
      if(j.ok){ showSaveSuccess(btn); }
    });
  });

  // Mobile save buttons
  document.querySelectorAll('.save-row-mobile').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const card = btn.closest('.product-card');
      const url = card.dataset.saveUrl;
      const payload = rowPayload(card);
      const res = await fetch(url,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      const j = await res.json();
      if(j.ok){ showSaveSuccess(btn); }
    });
  });



  // Save All functionality is handled in the separate script block below

  // Filters
  const catSel = document.getElementById('categoryFilter');
  const qIn = document.getElementById('searchInput');

  function applyFilters(){
    const cid = catSel.value;
    const q = qIn.value.toLowerCase();

    // Filter desktop table rows
    document.querySelectorAll('#calendarTable tbody tr').forEach(tr=>{
      const matchCat = !cid || tr.dataset.categoryId === cid;
      const name = tr.querySelector('td .fw-semibold')?.textContent.toLowerCase() || '';
      const matchQ = !q || name.includes(q);
      tr.style.display = (matchCat && matchQ) ? '' : 'none';
    });

    // Filter mobile cards
    document.querySelectorAll('.product-card').forEach(card=>{
      const matchCat = !cid || card.dataset.categoryId === cid;
      const name = card.querySelector('.card-header h6')?.textContent.toLowerCase() || '';
      const matchQ = !q || name.includes(q);
      card.style.display = (matchCat && matchQ) ? '' : 'none';
    });
  }

  catSel.addEventListener('change', applyFilters);
  qIn.addEventListener('input', applyFilters);

  // Toggle functionality is handled in the separate script block below
})();
</script>
{% endraw %}

<script>
// Jinja2 template variables for JavaScript
const isRtl = {{ 'true' if is_rtl else 'false' }};
const saveText = {{ '"حفظ"' if is_rtl else '"Save"' }};
const savedText = {{ '"تم الحفظ"' if is_rtl else '"Saved"' }};
const savingText = {{ '"جاري الحفظ..."' if is_rtl else '"Saving..."' }};
const allSavedText = {{ '"تم حفظ جميع المنتجات بنجاح"' if is_rtl else '"All products saved successfully"' }};
const desktopViewText = {{ '"عرض سطح المكتب"' if is_rtl else '"Desktop View"' }};
const mobileViewText = {{ '"عرض الموبايل"' if is_rtl else '"Mobile View"' }};

// Update save success feedback function
function showSaveSuccess(btn) {
  btn.classList.replace('btn-outline-primary','btn-success');
  btn.textContent = savedText;
  setTimeout(()=>{
    btn.classList.replace('btn-success','btn-outline-primary');
    btn.textContent = saveText;
  }, 1200);
}

// Update save all button text
document.getElementById('saveAll').addEventListener('click', async function() {
  const btn = this;
  const originalText = btn.textContent;
  btn.disabled = true;
  btn.textContent = savingText;

  // Get all containers (both desktop rows and mobile cards)
  const desktopRows = Array.from(document.querySelectorAll('#calendarTable tbody tr'));
  const mobileCards = Array.from(document.querySelectorAll('.product-card'));

  // Use desktop rows if visible, otherwise use mobile cards
  const containers = window.innerWidth >= 992 ? desktopRows : mobileCards;

  for(const container of containers){
    const url = container.dataset.saveUrl;
    const payload = rowPayload(container);
    await fetch(url,{
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
    });
  }

  btn.disabled = false;
  btn.textContent = originalText;
  alert(allSavedText);
});

// Toggle view functionality
const toggleBtn = document.getElementById('toggleView');
if (toggleBtn) {
  let isMobileView = window.innerWidth < 992;

  function updateToggleButton() {
    if (isMobileView) {
      toggleBtn.innerHTML = '<i class="fas fa-desktop"></i> ' + desktopViewText;
    } else {
      toggleBtn.innerHTML = '<i class="fas fa-mobile-alt"></i> ' + mobileViewText;
    }
  }

  function toggleViews() {
    const desktopView = document.getElementById('desktopView');
    const mobileView = document.getElementById('mobileView');

    if (isMobileView) {
      desktopView.classList.remove('d-none');
      mobileView.classList.add('d-none');
      desktopView.style.overflowX = 'auto';
    } else {
      desktopView.classList.add('d-none');
      mobileView.classList.remove('d-none');
    }

    isMobileView = !isMobileView;
    updateToggleButton();
  }

  updateToggleButton();
  toggleBtn.addEventListener('click', toggleViews);

  // Handle window resize
  window.addEventListener('resize', function() {
    if (window.innerWidth >= 992) {
      // Large screens - always show desktop view
      document.getElementById('desktopView').classList.remove('d-none');
      document.getElementById('mobileView').classList.add('d-none');
      toggleBtn.style.display = 'none';
    } else {
      // Small/medium screens - show toggle button
      toggleBtn.style.display = 'block';
    }
  });
}
</script>
{% endblock %}

