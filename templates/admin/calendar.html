{% extends 'admin/base.html' %}
{% block title %}Calendar{% endblock %}
{% block content %}
<div class="container-fluid">
  <div class="d-flex align-items-center justify-content-between mb-4 flex-wrap gap-2">
    <h1 class="h3 mb-0">{{ 'تقويم المواسم' if is_rtl else 'Seasonality Calendar' }}</h1>
    <div class="text-muted small">{{ 'انقر على الخلايا لتغيير الحالة: خارج الموسم → محدود → متاح → ذروة → مجمّد' if is_rtl else 'Click cells to cycle state: Off → Limited → Available → Peak → Frozen' }}</div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <div class="mb-3 d-flex gap-2">
        <select id="categoryFilter" class="form-select" style="max-width:260px">
          <option value="">{{ 'كل الفئات' if is_rtl else 'All Categories' }}</option>
          {% for c in categories %}<option value="{{ c.id }}">{{ c.get_name(get_locale()) }}</option>{% endfor %}
        </select>
        <input id="searchInput" class="form-control" placeholder="{{ 'ابحث عن منتج' if is_rtl else 'Search product' }}">
      </div>

      <div class="table-responsive">
        <table class="table align-middle mb-0" id="calendarTable">
          <thead class="table-light">
            <tr>
              <th style="min-width:240px">Product</th>
              {% set months_names_en = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'] %}
              {% set months_names_ar = ['يناير','فبراير','مارس','أبريل','مايو','يونيو','يوليو','أغسطس','سبتمبر','أكتوبر','نوفمبر','ديسمبر'] %}
              {% for i in range(1,13) %}
                <th class="text-center" style="width:64px">{{ months_names_ar[i-1] if is_rtl else months_names_en[i-1] }}</th>
              {% endfor %}
              <th class="text-center" style="width:100px">{{ 'إجراءات' if is_rtl else 'Actions' }}</th>
            </tr>
          </thead>
          <tbody>
            {% for p in products %}
            {% set data = p.get_seasonality_lang(get_locale()) %}
            {% if 'fresh' in data %}{% set data = data['fresh'] %}{% endif %}
            <tr data-product-id="{{ p.id }}" data-category-id="{{ p.category_id }}" data-save-url="{{ url_for('admin.calendar_save', product_id=p.id) }}">
              <td>
                <div class="fw-semibold d-flex align-items-center gap-2">
                  {{ p.get_name(get_locale()) }}

                </div>
                <div class="text-muted small">{{ p.category.get_name(get_locale()) if p.category }}</div>
              </td>
              {% for i in range(1,13) %}
                {% set s='off' %}
                {% if data and i in (data.get('peak') or []) %}{% set s='peak' %}
                {% elif data and i in (data.get('available') or []) %}{% set s='available' %}
                {% elif data and i in (data.get('limited') or []) %}{% set s='limited' %}
                {% elif data and i in (data.get('iqf') or []) %}{% set s='iqf' %}
                {% endif %}
                <td class="text-center">
                  <button class="cell btn btn-sm state-{{ s }}" data-month="{{ i }}" aria-label="{{ i }}"></button>
                </td>
              {% endfor %}
              <td class="text-center">
                <button class="btn btn-outline-primary btn-sm save-row">{{ 'حفظ' if is_rtl else 'Save' }}</button>
              </td>
            </tr>

            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="mt-3 d-flex align-items-center gap-3">
        <div class="d-flex align-items-center gap-3">
          <span class="legend l-peak"></span> {{ 'ذروة' if is_rtl else 'Peak' }}
          <span class="legend l-available"></span> {{ 'متاح' if is_rtl else 'Available' }}
          <span class="legend l-limited"></span> {{ 'محدود' if is_rtl else 'Limited' }}
          <span class="legend l-off"></span> {{ 'خارج الموسم' if is_rtl else 'Off' }}
          <span class="legend" style="background:#5bc0de; border-color:#5bc0de;"></span> {{ 'مجمّد' if is_rtl else 'Frozen' }}
        </div>
        <button id="saveAll" class="btn btn-success ms-auto">{{ 'حفظ الكل' if is_rtl else 'Save All' }}</button>
      </div>
    </div>
  </div>
</div>

<style>
  #calendarTable .cell { width:32px; height:24px; border-radius:6px; border:1px solid #e5e7eb; padding:0; }
  .state-peak{ background:#2c5f4f; border-color:#2c5f4f; } /* dark green */
  .state-available{ background:#689b8a; border-color:#689b8a; } /* primary green */
  .state-limited{ background:#f9cb99; border-color:#f9cb99; } /* peach */
  .state-off{ background:#adb5bd; border-color:#adb5bd; } /* gray */
  .state-iqf{ background:#5bc0de; border-color:#5bc0de; } /* new blue for frozen */
  .legend{ width:14px; height:14px; display:inline-block; border-radius:4px; border:1px solid #e5e7eb; }
  .l-peak{ background:#2c5f4f; border-color:#2c5f4f; }
  .l-available{ background:#689b8a; border-color:#689b8a; }
  .l-limited{ background:#f9cb99; border-color:#f9cb99; }
  .l-off{ background:#adb5bd; border-color:#adb5bd; }
</style>

<script>
(function(){
  // Cycle now includes IQF as a fifth state
  const nextState = { 'off':'limited', 'limited':'available', 'available':'peak', 'peak':'iqf', 'iqf':'off' };
  document.querySelectorAll('#calendarTable .cell').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const classes = Array.from(btn.classList);
      const current = classes.find(c=>c.startsWith('state-')).replace('state-','');
      const ns = nextState[current] || 'off';
      classes.forEach(c=>{ if(c.startsWith('state-')) btn.classList.remove(c); });
      btn.classList.add('state-'+ns);
    });
  });

  function rowPayload(tr){
  // Save rows: send five-state months including 'iqf' directly
  document.querySelectorAll('.save-row').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const tr = btn.closest('tr');
      const url = tr.dataset.saveUrl;
      const payload = rowPayload(tr); // includes iqf now
      const res = await fetch(url,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      const j = await res.json();
      if(j.ok){ btn.classList.replace('btn-outline-primary','btn-success'); btn.textContent='{{ "تم الحفظ" if is_rtl else "Saved" }}'; setTimeout(()=>{btn.classList.replace('btn-success','btn-outline-primary'); btn.textContent='{{ "حفظ" if is_rtl else "Save" }}';},1200); }
    });
  });
    const months = {peak:[], available:[], limited:[], off:[], iqf:[]};
    tr.querySelectorAll('.cell').forEach(b=>{
      const m = parseInt(b.dataset.month,10);
      let s = Array.from(b.classList).find(c=>c.startsWith('state-'));
      s = s ? s.replace('state-','') : 'off';
      if(!months[s]) months[s] = [];
      months[s].push(m);
    });
    return months;
  }



  document.getElementById('saveAll').addEventListener('click', async ()=>{
    const rows = Array.from(document.querySelectorAll('#calendarTable tbody tr'));
    for(const tr of rows){
      const url = tr.dataset.saveUrl; const payload = rowPayload(tr);
      await fetch(url,{
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
      });
    }
    alert('All saved');
  });

  // Filters
  const catSel = document.getElementById('categoryFilter');
  const qIn = document.getElementById('searchInput');
  function applyFilters(){
    const cid = catSel.value; const q = qIn.value.toLowerCase();
    document.querySelectorAll('#calendarTable tbody tr').forEach(tr=>{
      const matchCat = !cid || tr.dataset.categoryId === cid;
      const name = tr.querySelector('td .fw-semibold')?.textContent.toLowerCase() || '';
      const matchQ = !q || name.includes(q);
      tr.style.display = (matchCat && matchQ) ? '' : 'none';
    });
  }
  catSel.addEventListener('change', applyFilters);
  qIn.addEventListener('input', applyFilters);
})();
</script>
{% endblock %}

