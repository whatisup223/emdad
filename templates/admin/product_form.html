{% extends "admin/base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="card-title">{{ title }}</h3>
                    <a href="{{ url_for('admin.products') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> العودة للقائمة
                    </a>
                </div>
                <div class="card-body">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}

                    <form method="POST" enctype="multipart/form-data" id="productForm">
                        {{ form.hidden_tag() }}

                        <!-- Debug CSRF Token -->
                        {% if config.DEBUG %}
                        <div class="alert alert-info small">
                            <strong>Debug:</strong> CSRF Token: {{ csrf_token() }}
                        </div>
                        {% endif %}

                        <!-- CSRF Error Alert (hidden by default) -->
                        <div id="csrfErrorAlert" class="alert alert-danger" style="display: none;">
                            <strong>خطأ في الأمان:</strong> انتهت صلاحية النموذج. يرجى إعادة تحميل الصفحة والمحاولة مرة أخرى.
                            <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="location.reload()">
                                إعادة تحميل الصفحة
                            </button>
                        </div>
                        
                        <!-- Basic Information -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.name_en.label(class="form-label") }}
                                    {{ form.name_en(class="form-control" + (" is-invalid" if form.name_en.errors else "")) }}
                                    {% if form.name_en.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.name_en.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.name_ar.label(class="form-label") }}
                                    {{ form.name_ar(class="form-control" + (" is-invalid" if form.name_ar.errors else ""), dir="rtl") }}
                                    {% if form.name_ar.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.name_ar.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    {{ form.slug.label(class="form-label") }}
                                    {{ form.slug(class="form-control" + (" is-invalid" if form.slug.errors else "")) }}
                                    {% if form.slug.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.slug.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    {{ form.category_id.label(class="form-label") }}
                                    {{ form.category_id(class="form-select" + (" is-invalid" if form.category_id.errors else "")) }}
                                    {% if form.category_id.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.category_id.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    {{ form.hs_code.label(class="form-label") }}
                                    {{ form.hs_code(class="form-control" + (" is-invalid" if form.hs_code.errors else "")) }}
                                    {% if form.hs_code.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.hs_code.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">
                                        <i class="fas fa-info-circle"></i>
                                        رقم HS للمنتج (مثال: 080510)
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    {{ form.status.label(class="form-label") }}
                                    {{ form.status(class="form-select" + (" is-invalid" if form.status.errors else "")) }}
                                    {% if form.status.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.status.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Descriptions -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.short_description_en.label(class="form-label") }}
                                    {{ form.short_description_en(class="form-control" + (" is-invalid" if form.short_description_en.errors else ""), rows="3") }}
                                    {% if form.short_description_en.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.short_description_en.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.short_description_ar.label(class="form-label") }}
                                    {{ form.short_description_ar(class="form-control" + (" is-invalid" if form.short_description_ar.errors else ""), rows="3", dir="rtl") }}
                                    {% if form.short_description_ar.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.short_description_ar.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.description_en.label(class="form-label") }}
                                    {{ form.description_en(class="form-control" + (" is-invalid" if form.description_en.errors else ""), rows="5") }}
                                    {% if form.description_en.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.description_en.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.description_ar.label(class="form-label") }}
                                    {{ form.description_ar(class="form-control" + (" is-invalid" if form.description_ar.errors else ""), rows="5", dir="rtl") }}
                                    {% if form.description_ar.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.description_ar.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Specifications Section -->
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="fas fa-list-ul me-2"></i>Product Specifications
                                    <small class="text-muted ms-2">- Displayed in organized table format</small>
                                </h6>
                            </div>
                            <div class="card-body">
                                <!-- Format Guide -->
                                <div class="alert alert-info border-0 mb-3">
                                    <h6 class="alert-heading mb-2">
                                        <i class="fas fa-info-circle me-1"></i>Specification Format Guide
                                    </h6>
                                    <p class="mb-2"><strong>Use JSON format for structured specifications:</strong></p>
                                    <pre class="bg-white p-2 rounded border small mb-2">{
  "Essential Oil (EO)": "0.3–1.5% (starter target: ISO 6571/ASTA)",
  "Cut Sizes": "Whole leaf • Crushed 3–6 mm • Tea Bag Cut 1–3 mm • Powder 60–120 mesh",
  "Moisture": "≤ 10–12% (typical)",
  "Color": "Green retention target: sortex available",
  "Metal Detection": "Ferrous/Non-ferrous/SS per QA plan",
  "Crop Year": "Current season (declare on COA)"
}</pre>
                                    <p class="mb-0"><small class="text-muted">
                                        <strong>Tips:</strong> Use bullet points (•) to separate multiple values.
                                        HS Code will be automatically included in the specifications table.
                                    </small></p>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            {{ form.specifications_en.label(class="form-label") }}
                                            {{ form.specifications_en(class="form-control" + (" is-invalid" if form.specifications_en.errors else ""), rows="8", placeholder='{"Essential Oil (EO)": "0.3–1.5% (starter target: ISO 6571/ASTA)", "Cut Sizes": "Whole leaf • Crushed 3–6 mm", "Moisture": "≤ 10–12% (typical)"}') }}
                                            {% if form.specifications_en.errors %}
                                                <div class="invalid-feedback">
                                                    {% for error in form.specifications_en.errors %}{{ error }}{% endfor %}
                                                </div>
                                            {% endif %}
                                            <div class="form-text">
                                                <i class="fas fa-lightbulb me-1"></i>
                                                Use JSON format for structured table display
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            {{ form.specifications_ar.label(class="form-label") }}
                                            {{ form.specifications_ar(class="form-control" + (" is-invalid" if form.specifications_ar.errors else ""), rows="8", dir="rtl", placeholder='{"الزيت العطري": "0.3–1.5% (الهدف المبدئي: ISO 6571/ASTA)", "أحجام القطع": "ورقة كاملة • مطحون 3–6 مم", "الرطوبة": "≤ 10–12% (نموذجي)"}') }}
                                            {% if form.specifications_ar.errors %}
                                                <div class="invalid-feedback">
                                                    {% for error in form.specifications_ar.errors %}{{ error }}{% endfor %}
                                                </div>
                                            {% endif %}
                                            <div class="form-text" dir="rtl">
                                                <i class="fas fa-lightbulb me-1"></i>
                                                استخدم تنسيق JSON للعرض المنظم في الجدول
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Preview Button -->
                                <div class="text-center">
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="previewSpecifications()">
                                        <i class="fas fa-eye me-1"></i>Preview Table Format
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- SEO Fields -->
                        <h5 class="mt-4 mb-3">SEO Settings</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.seo_title_en.label(class="form-label") }}
                                    {{ form.seo_title_en(class="form-control" + (" is-invalid" if form.seo_title_en.errors else "")) }}
                                    {% if form.seo_title_en.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.seo_title_en.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.seo_title_ar.label(class="form-label") }}
                                    {{ form.seo_title_ar(class="form-control" + (" is-invalid" if form.seo_title_ar.errors else ""), dir="rtl") }}
                                    {% if form.seo_title_ar.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.seo_title_ar.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.seo_description_en.label(class="form-label") }}
                                    {{ form.seo_description_en(class="form-control" + (" is-invalid" if form.seo_description_en.errors else ""), rows="3") }}
                                    {% if form.seo_description_en.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.seo_description_en.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.seo_description_ar.label(class="form-label") }}
                                    {{ form.seo_description_ar(class="form-control" + (" is-invalid" if form.seo_description_ar.errors else ""), rows="3", dir="rtl") }}
                                    {% if form.seo_description_ar.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.seo_description_ar.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Settings -->
                        <h5 class="mt-4 mb-3">Settings</h5>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form.sort_order.label(class="form-label") }}
                                    {{ form.sort_order(class="form-control" + (" is-invalid" if form.sort_order.errors else "")) }}
                                    {% if form.sort_order.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.sort_order.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">&nbsp;</label>
                                    <div class="form-check">
                                        {{ form.featured(class="form-check-input") }}
                                        {{ form.featured.label(class="form-check-label") }}
                                    </div>
                                    <div class="form-check mt-2">
                                        {{ form.show_on_homepage(class="form-check-input") }}
                                        {{ form.show_on_homepage.label(class="form-check-label") }}
                                        <div class="form-text text-info">
                                            <i class="fas fa-info-circle"></i>
                                            سيتم عرض هذا المنتج في قسم "المنتجات المميزة" بالصفحة الرئيسية
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Image Upload -->
                        <div class="mb-3">
                            {{ form.image.label(class="form-label") }}
                            {{ form.image(class="form-control" + (" is-invalid" if form.image.errors else "")) }}
                            {% if form.image.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.image.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                            {% if product and product.image_path %}
                                <div class="mt-2">
                                    <small class="text-muted">الصورة الحالية:</small><br>
                                    <img src="{{ url_for('main.uploaded_file', filename='products/' + product.image_path) }}"
                                         alt="{{ product.name_en }}" class="img-thumbnail" style="max-width: 200px;">
                                </div>
                            {% endif %}
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('admin.products') }}" class="btn btn-secondary">{{ _('Cancel') }}</a>
                            <button type="submit" class="btn btn-primary">
                                {% if product %}
                                    <i class="fas fa-save"></i> {{ _('Save') }}
                                {% else %}
                                    <i class="fas fa-plus"></i> {{ _('Add New Product') }}
                                {% endif %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Auto-generate slug from English name
document.getElementById('name_en').addEventListener('input', function() {
    const nameEn = this.value;
    const slug = nameEn.toLowerCase()
        .replace(/[^a-z0-9\s-]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .trim('-');
    document.getElementById('slug').value = slug;
});

// Handle form submission with CSRF error handling
document.getElementById('productForm').addEventListener('submit', function(e) {
    // Hide any previous CSRF error
    document.getElementById('csrfErrorAlert').style.display = 'none';

    // Add loading state to submit button
    const submitBtn = this.querySelector('button[type="submit"]');
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>جاري الحفظ...';
    }
});

// Handle CSRF errors globally
window.addEventListener('load', function() {
    // Check if there's a CSRF error in the URL or flash messages
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('csrf_error') || document.querySelector('.alert-danger')) {
        const errorText = document.querySelector('.alert-danger')?.textContent;
        if (errorText && errorText.includes('CSRF')) {
            document.getElementById('csrfErrorAlert').style.display = 'block';
            window.scrollTo(0, 0);
        }
    }
});

// Preview specifications function
function previewSpecifications() {
    const specsEn = document.getElementById('specifications_en').value;
    const specsAr = document.getElementById('specifications_ar').value;
    const productName = document.getElementById('name_en').value || 'Product Name';
    const hsCode = document.getElementById('hs_code').value;

    let previewHtml = `
        <div class="modal fade" id="specsPreviewModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-eye me-2"></i>Specifications Preview
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary mb-3">English Version</h6>
                                <div class="specifications-table">
                                    <table class="table table-borderless">
                                        <tbody>
                                            <tr>
                                                <td class="spec-label"><strong>Product</strong></td>
                                                <td class="spec-value">${productName}</td>
                                            </tr>`;

    if (hsCode) {
        previewHtml += `
                                            <tr>
                                                <td class="spec-label"><strong>HS Code</strong></td>
                                                <td class="spec-value">${hsCode}</td>
                                            </tr>`;
    }

    if (specsEn) {
        try {
            const specs = JSON.parse(specsEn);
            for (const [key, value] of Object.entries(specs)) {
                previewHtml += `
                                            <tr>
                                                <td class="spec-label"><strong>${key}</strong></td>
                                                <td class="spec-value">${value}</td>
                                            </tr>`;
            }
        } catch (e) {
            previewHtml += `
                                            <tr>
                                                <td colspan="2" class="text-danger">
                                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                                    Invalid JSON format in English specifications
                                                </td>
                                            </tr>`;
        }
    }

    previewHtml += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-primary mb-3">Arabic Version</h6>
                                <div class="specifications-table">
                                    <table class="table table-borderless">
                                        <tbody>
                                            <tr>
                                                <td class="spec-label"><strong>المنتج</strong></td>
                                                <td class="spec-value">${productName}</td>
                                            </tr>`;

    if (hsCode) {
        previewHtml += `
                                            <tr>
                                                <td class="spec-label"><strong>كود النظام المنسق</strong></td>
                                                <td class="spec-value">${hsCode}</td>
                                            </tr>`;
    }

    if (specsAr) {
        try {
            const specs = JSON.parse(specsAr);
            for (const [key, value] of Object.entries(specs)) {
                previewHtml += `
                                            <tr>
                                                <td class="spec-label"><strong>${key}</strong></td>
                                                <td class="spec-value">${value}</td>
                                            </tr>`;
            }
        } catch (e) {
            previewHtml += `
                                            <tr>
                                                <td colspan="2" class="text-danger">
                                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                                    تنسيق JSON غير صحيح في المواصفات العربية
                                                </td>
                                            </tr>`;
        }
    }

    previewHtml += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <style>
        .spec-label {
            width: 35%;
            padding: 0.75rem;
            background: #f8f9fa;
            color: #6c757d;
            font-size: 0.9rem;
            border-right: 1px solid #e9ecef;
        }
        .spec-value {
            padding: 0.75rem;
            color: #495057;
        }
        .specifications-table tr {
            border-bottom: 1px solid #f8f9fa;
        }
        </style>`;

    // Remove existing modal if any
    const existingModal = document.getElementById('specsPreviewModal');
    if (existingModal) {
        existingModal.remove();
    }

    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', previewHtml);

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('specsPreviewModal'));
    modal.show();
}
</script>
{% endblock %}
