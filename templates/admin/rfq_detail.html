{% extends "admin/base.html" %}

{% block title %}{{ _('RFQ Details') }} #{{ rfq.id }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="card-title">{{ _('RFQ Details') }} #{{ rfq.id }}</h3>
                    <a href="{{ url_for('admin.rfqs') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> {{ _('Back to List') }}
                    </a>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Customer Information -->
                        <div class="col-md-6">
                            <h5 class="mb-3">{{ _('Customer Information') }}</h5>
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong>{{ _('Name') }}:</strong></td>
                                    <td>{{ rfq.name }}</td>
                                </tr>
                                <tr>
                                    <td><strong>{{ _('Email') }}:</strong></td>
                                    <td>{{ rfq.email }}</td>
                                </tr>
                                <tr>
                                    <td><strong>{{ _('Phone') }}:</strong></td>
                                    <td>{{ rfq.phone or '-' }}</td>
                                </tr>
                                <tr>
                                    <td><strong>{{ _('Company') }}:</strong></td>
                                    <td>{{ rfq.company or '-' }}</td>
                                </tr>
                                <tr>
                                    <td><strong>{{ _('Country') }}:</strong></td>
                                    <td>{{ rfq.country }}</td>
                                </tr>
                            </table>
                        </div>

                        <!-- Request Information -->
                        <div class="col-md-6">
                            <h5 class="mb-3">{{ _('Request Information') }}</h5>
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong>{{ _('Status') }}:</strong></td>
                                    <td>
                                        {% if rfq.status == 'new' %}
                                            <span class="badge bg-warning">{{ _('New') }}</span>
                                        {% elif rfq.status == 'in_progress' %}
                                            <span class="badge bg-info">{{ _('In Progress') }}</span>
                                        {% elif rfq.status == 'completed' %}
                                            <span class="badge bg-success">{{ _('Completed') }}</span>
                                        {% elif rfq.status == 'cancelled' %}
                                            <span class="badge bg-secondary">{{ _('Cancelled') }}</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ rfq.status }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>{{ _('Priority') }}:</strong></td>
                                    <td>
                                        {% if rfq.priority == 'high' %}
                                            <span class="badge bg-danger">{{ _('High') }}</span>
                                        {% elif rfq.priority == 'medium' %}
                                            <span class="badge bg-warning">{{ _('Medium') }}</span>
                                        {% elif rfq.priority == 'low' %}
                                            <span class="badge bg-success">{{ _('Low') }}</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ rfq.priority }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>{{ _('Created At') }}:</strong></td>
                                    <td>{{ rfq.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                </tr>
                                <tr>
                                    <td><strong>{{ _('Updated At') }}:</strong></td>
                                    <td>{{ rfq.updated_at.strftime('%Y-%m-%d %H:%M') if rfq.updated_at else '-' }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <hr>

                    <!-- تفاصيل المنتج -->
                    <div class="row">
                        <div class="col-12">
                            <h5 class="mb-3">{{ _('Product Details') }}</h5>
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong>{{ _('Category') }}:</strong></td>
                                    <td>{{ rfq.category.get_name() if rfq.category else '-' }}</td>
                                </tr>
                                <tr>
                                    <td><strong>{{ _('Product') }}:</strong></td>
                                    <td>{{ rfq.product_name or '-' }}</td>
                                </tr>
                                <tr>
                                    <td><strong>{{ _('Quantity') }}:</strong></td>
                                    <td>{{ rfq.quantity or '-' }}</td>
                                </tr>
                                <tr>
                                    <td><strong>{{ _('Packaging Preferences') }}:</strong></td>
                                    <td>{{ rfq.packaging_preference or '-' }}</td>
                                </tr>
                                <tr>
                                    <td><strong>{{ _('Delivery Date') }}:</strong></td>
                                    <td>{{ rfq.delivery_date.strftime('%Y-%m-%d') if rfq.delivery_date else '-' }}</td>
                                </tr>
                                <tr>
                                    <td><strong>{{ _('Budget') }}:</strong></td>
                                    <td>{{ rfq.budget or '-' }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>

                        <hr>

                        <!-- Attachments -->
                        <div class="row">
                          <div class="col-12">
                            <h5 class="mb-3">{{ _('Attachments') }}</h5>
                            {% if rfq.attachment_path %}
                              <div class="list-group">
                                <a class="list-group-item list-group-item-action d-flex align-items-center" href="{{ url_for('admin.rfq_download_attachment', id=rfq.id) }}">
                                  <i class="fas fa-paperclip me-2"></i>
                                  <span class="me-2">{{ rfq.attachment_path }}</span>
                                  <span class="badge bg-light text-dark ms-auto"><i class="fas fa-download me-1"></i>{{ _('Download') }}</span>
                                </a>
                              </div>
                            {% else %}
                              <p class="text-muted mb-0">{{ _('No attachments') }}</p>
                            {% endif %}
                          </div>
                        </div>


                    <hr>

                    <!-- الرسالة -->
                    <div class="row">
                        <div class="col-12">
                            <h5 class="mb-3">{{ _('Message') }}</h5>
                            <div class="card bg-light">
                                <div class="card-body">
                                    <p class="mb-0">{{ rfq.message or _('Not available') }}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <!-- إجراءات -->
                    <div class="row">
                        <div class="col-12">
                            <h5 class="mb-3">{{ _('Actions') }}</h5>
                            <div class="btn-group me-2">
                                <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                    {{ _('Change Status') }}
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="updateStatus('new')">{{ _('New') }}</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="updateStatus('in_progress')">{{ _('In Progress') }}</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="updateStatus('completed')">{{ _('Completed') }}</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="updateStatus('cancelled')">{{ _('Cancelled') }}</a></li>
                                </ul>
                            </div>

                            <div class="btn-group me-2">
                                <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                    {{ _('Change Priority') }}
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="updatePriority('low')">{{ _('Low') }}</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="updatePriority('medium')">{{ _('Medium') }}</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="updatePriority('high')">{{ _('High') }}</a></li>
                                </ul>
                            </div>

                            <a href="mailto:{{ rfq.email }}?subject={{ _('RFQ Reply') }} #{{ rfq.id }}" class="btn btn-primary">
                                <i class="fas fa-envelope"></i> {{ _('Send Email Reply') }}
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function updateStatus(newStatus) {
    if (confirm("{{ _('Are you sure?') }}")) {
        fetch(`/admin/rfqs/{{ rfq.id }}/status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
            },
            body: JSON.stringify({status: newStatus})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert("{{ _('Error') }}");
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert("{{ _('Error') }}");
        });
    }
}

function updatePriority(newPriority) {
    if (confirm("{{ _('Are you sure?') }}")) {
        fetch(`/admin/rfqs/{{ rfq.id }}/priority`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
            },
            body: JSON.stringify({priority: newPriority})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert("{{ _('Error') }}");
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert("{{ _('Error') }}");
        });
    }
}
</script>
{% endblock %}
